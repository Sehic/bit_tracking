@import helpers.PackageType
@import helpers.SessionHelper

@(offices: List[PostOffice])(places: List[Location])(text: Form[models.Package])(implicit currentUser: User = SessionHelper.getCurrentUser(ctx()))
@adminmain("Add Package") {
    <div class="container-fluid">
            <!--Register title row -->
        <div class="row">
            <div class="col-md-12">
                <h3>
                    Add Package
                </h3><br/>
                <h5>This form is used to schedule a shipment with Bit Tracking. Fill out the form and click "Add Package" to obtain rate information for this shipment.</h5>
                <br/>
            </div>
        </div> <!--End register title  row-->

        <div class="col-md-12">
        @if(flash.containsKey("wrongFormatBoth")) {
            <div class="alert alert-danger col-md-12">
                <b style="font-size : 18px ; color : red"><center>@flash.get("wrongFormatBoth")</center></b>
            </div>
        }
        </div>

            <!--=======Form row============ -->
        <div class="row">

        @helper.form(action = routes.PackageController.savePackage(), 'class -> "form-horizontal", 'role -> "form") {

                <!--Starts Origination-->
            <div class="col-md-6">
                <fieldset>
                    <legend><h5 style="color: #419641"><strong>Origination</strong></h5></legend>

                    <div class="form-group col-md-12">
                        <label for="senderName" class="col-sm-2" style="font-size: 12px">
                            Sender's Name:
                        </label>
                        <div class="col-sm-10">
                            <input placeholder="" name="senderName" type="text" class="form-control" id="senderName" required="required" value="@text("senderName").value">
                        </div>
                    </div>

                    <div class="form-group col-md-12">
                        <label for="postOffices" class="col-sm-2" style="font-size: 12px">
                            Initial Post Office:
                        </label>
                        <div class="col-md-5">
                        @if(currentUser.typeOfUser == UserType.ADMIN) {
                            <select id="initialOffice" class="form-control sortAlphabetically" name="officePost" required="required">
                                <option>--Select one--</option>
                                @for(office <- offices) {
                                    <option value="@office.address">@office.name</option>
                                }
                            </select>
                        } else {
                            <div class="form-group">
                                <input class="form-control" value="@currentUser.postOffice.name" id="postOffices" name="officePost" type="text" readonly/>
                            </div>

                        </div>

                    </div>

                    <div class="form-group col-md-12">
                        <label for="initialOffice" class="col-sm-2" style="font-size: 12px">
                            Address:
                        </label>
                        <div class="col-md-5">
                            <input class="form-control" value="@currentUser.postOffice.address" id="initialOffice" name="initialOffice" type="text" readonly/>
                        </div>
                    </div>
                    }
                    <span id="wrongInitialOffice" class="alert-danger" data-error-for="" >@flash.get("wrongInitialOffice")</span>
                </fieldset>

            </div>
            <div class="col-md-6">
                    <!--Start origination-->
                <fieldset>
                    <legend ><h5 style="color: #419641"><strong>Destination</strong></h5></legend>
                    <div class="form-group col-md-12">
                        <label for="recipientName" class="col-sm-2" style="font-size: 12px">
                            Recipient's Name:
                        </label>
                        <div class="col-sm-10">
                            <input name="recipientName" type="text" class="form-control" id="recipientName" required="required" value="@text("recipientName").value">
                        </div>
                    </div>

                    <div class="form-group col-md-12">
                        <label for="recipientAddress" class="col-sm-2" style="font-size: 12px">
                            Recipient's Address:
                        </label>
                        <div class="col-sm-10">
                            <input name="recipientAddress" type="text" class="form-control" id="recipientAddress" required="required" value="@text("recipientAddress").value">
                        </div>
                    </div>


                    <div class="form-group col-md-12">
                        <label for="destination" class="col-sm-2" style="font-size: 12px">
                            Final Post Office:
                        </label>
                        <div class="col-md-5">
                            <select id="finalOffice" class="form-control sortAlphabetically" name="destination" required="required">
                                <option class="default">--Select one--</option>
                                @for(office <- offices) {
                                    @if(currentUser.postOffice !=null){
                                        @if(currentUser.postOffice.id != office.id){
                                            <option value="@office.name">@office.name</option>
                                        }
                                    }else {
                                        <option value="@office.name">@office.name</option>
                                    }
                                }
                            </select>
                        </div>
                        <span id="wrongFinalOffice" class="alert-danger" data-error-for="" >@flash.get("wrongFinalOffice")</span>
                    </div></fieldset>
            </div> <!--ends Destionation-->

        </div> <!--Ends origination-->

        <!--Starts Service Options-->
        <div class="row">
            <div class="col-md-6">
                <fieldset>
                    <legend><h5 style="color: #419641"><strong>Service Options</strong></h5></legend>
                    <div class="form-group col-md-12">
                        <label for="weight" class="col-sm-2" style="font-size: 12px">
                            Package Weight:
                        </label>
                        <div class="col-sm-10">
                            <input placeholder="Weight in kg" name="weight" value="@text("weight").value" type="text" class="form-control" id="weight" required="required">
                        </div>
                    </div>

                    <div class="form-group col-md-12">
                        <label for="price" class="col-sm-2" style="font-size: 12px">
                            Package Price:
                        </label>
                        <div class="col-sm-10">
                            <input placeholder="Price in KM" name="price" value="@text("price").value" type="text" class="form-control" id="price" required="required">
                        </div>
                    </div>


                    <div class="form-group col-md-12">
                        <label for="packageType" class="col-sm-2" style="font-size: 12px">
                            Type of Package:
                        </label>
                        <div class="col-sm-5">
                            <select class="form-control" name="packageType">
                                <option class="default">--Select one--</option>
                                <option value="@PackageType.BOX">@PackageType.BOX</option>
                                <option value="@PackageType.ENVELOPE">@PackageType.ENVELOPE</option>
                                <option value="@PackageType.FLYER">@PackageType.FLYER</option>
                                <option value="@PackageType.TUBE">@PackageType.TUBE</option>
                            </select>
                        </div>
                    </div>
                </fieldset>
            </div>
            <div class="col-md-6">
                <fieldset>
                    <legend><h5 style="color: #419641"><strong>Route Options</strong></h5></legend>
                    <div class="form-group col-md-12">
                        <label for="distanceBetweenOffices" class="col-sm-2" style="font-size: 12px">
                            Distance:
                        </label>
                        <div class="col-sm-10">
                            <input id="distanceBetweenOffices" placeholder="Distance between Post Offices" name="distanceBetweenOffices" value="" type="text" class="form-control" disabled>
                        </div>
                    </div>
                    <div class="form-group col-md-12">
                        <label for="tripDurationBetweenOffices" class="col-sm-2" style="font-size: 12px">
                            Duration:
                        </label>
                        <div class="col-sm-10">
                            <input id="tripDurationBetweenOffices" placeholder="Travel duration between Post Offices" name="tripDurationBetweenOffices" value="" type="text" class="form-control" disabled>
                        </div>
                    </div>
                </fieldset>

            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-5" style="margin-bottom : 3%;">
                <input type="submit" class="btn btn-primary" value="Add Package">
            </div>
            <div class="col-sm-6" style="margin-bottom : 3%; padding-left: 9.8%" >
                <input id="clickMe" type="button" class="btn btn-primary" value="Suggest Route"/>
            </div>
        </div>

    }
        <div>
            <input id="loc" type="hidden" value="@places.toString()">
        </div>


        <div class="templatemo-maps">
            <div class="row">
                <div class="col-md-12 margin-bottom-30">
                    <div id="map" style="position: relative; height: 700px; width: auto"></div>



                    <script type="text/javascript">

     var map;
     var i, marker;
     var polys = new Array();
     var jot=0;
     var myPolygons=new Array();

function initialize(){
        map = new google.maps.Map(document.getElementById('map'), {
        zoom: 7,
        center: new google.maps.LatLng(43.8331, 18.3039),
        mapTypeId: google.maps.MapTypeId.ROADMAP
     });
// Construct a new InfoWindow.
     var list = document.getElementById("loc").value;


     @for(place <- places) {

         var placey1 = @place.y+0.1724;
         var placey2 = @place.y+0.131;
         var placey3 = @place.y-0.129;
         var placey4 = @place.y-0.082;

         var placex1 = @place.x-0.200;
         var placex2 = @place.x+0.159;
         var placex3 = @place.x+0.186;
         var placex4 = @place.x-0.183;

         marker = new google.maps.Marker({
            position: new google.maps.LatLng(@place.y
                        , @place.x),
            map: map
         });

        myPolygons.push(
            {
            "name": "zone"+jot,
                "coordinates": [

                    placey1.toString()+","+placex1.toString(),
                    placey2.toString()+","+placex2.toString(),
                    placey3.toString()+","+placex3.toString(),
                    placey4.toString()+","+placex4.toString()

                ]
            }
         )
         jot++;
     }

    sendPolygonForDrawing();
}


function showMap(){

        var initial = document.getElementById("initialOffice").value;
        var final = document.getElementById("finalOffice").value;

        google.maps.event.addDomListener(window, 'resize', function() {
        map.setCenter(marker.getPosition());
        });

        @for(office <- offices) {
            var officeName="@office.name";
            if(final === officeName){
                 var finalAddress = "@office.address";
            }
        }
        var directionsService = new google.maps.DirectionsService();

        var renderOptions = { draggable: true };
        var directionDisplay = new google.maps.DirectionsRenderer(renderOptions);


        //set the directions display service to the map
        directionDisplay.setMap(map);

        //set the starting address and destination address
        var originAddress = initial;
        var destinationAddress = finalAddress;

        //build directions request
        var request = {
            origin: originAddress,
            destination: destinationAddress,
            provideRouteAlternatives: true,
            travelMode: google.maps.DirectionsTravelMode.DRIVING
        };

        //get the route from the directions service
        var middleOfficeAddress=[];
directionsService.route(request, function (response, status) {
    if(status == google.maps.DirectionsStatus.OK) {

        new google.maps.DirectionsRenderer({
            map: map,
            directions: response,
            routeIndex: 0
        });

        var routCoordinates = fncRouteZoneIntersection(response);//this function populates the routCoordinates with the JSON data of the route.
        var exist = new Array();

        for (var i = 0; i < polys.length; i++) {
            for (var j = 0; j < routCoordinates.length; j++){

                if (google.maps.geometry.poly.containsLocation(routCoordinates[j], polys[i]) == true){

                    @for(office <- offices){
                        var coorX=@office.place.y;
                        var coorY=@office.place.x;
                        var isWithinPolygon = polys[i].containsLatLng(coorX, coorY);
                        if(isWithinPolygon){
                             var officeAddress = "@office.address";
                             middleOfficeAddress.push(officeAddress);
                        }
                    }
                 exist.push(polys[i].polyTitle);
                break;
                }
                        /*this breaks the loop checking when a point is found inside a polygon and go check the next one, because knowing that one point of the route is inside a polygon is enough*/
            }
        }

        //set the directions display service to the map
        directionDisplay.setMap(map);

        var waypoints = [];
        //set the starting address and destination address
        var originAddress = initial;
        var destinationAddress = finalAddress;
        for (var i = 0; i < middleOfficeAddress.length; i++) {
            var address = middleOfficeAddress[i];
            if(address !== "" && address!==destinationAddress && address!==originAddress) {
                waypoints.push({
                    location: address,
                    stopover: true
                });
            }
        }

        //build directions request
        var request = {
            origin: originAddress,
            destination: destinationAddress,
            provideRouteAlternatives: true,
            waypoints: waypoints, //an array of waypoints
            optimizeWaypoints: true, //set to true if you want google to determine the shortest route or false to use the order specified.
            travelMode: google.maps.DirectionsTravelMode.DRIVING
        };

        directionsService.route(request, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
              for (var i = 0, len = response.routes.length; i < len; i++) {
                new google.maps.DirectionsRenderer({
                    map: map,
                    directions: response,
                    routeIndex: i
                });
               }
            }
        });
    }
});
        calculateDistance(originAddress, destinationAddress);

}

function calculateDistance(originAddress, destinationAddress){
var service = new google.maps.DistanceMatrixService;
  service.getDistanceMatrix({
    origins: [originAddress],
    destinations: [destinationAddress],
    travelMode: google.maps.TravelMode.DRIVING,
    unitSystem: google.maps.UnitSystem.METRIC,
    avoidHighways: false,
    avoidTolls: false
  }, function(response, status) {
    if (status !== google.maps.DistanceMatrixStatus.OK) {
      alert('Error was: ' + status);
    } else {
      var originList = response.originAddresses;
      var destinationList = response.destinationAddresses;

      for (var i = 0; i < originList.length; i++) {
        var results = response.rows[i].elements;

        for (var j = 0; j < results.length; j++) {
            $("#distanceBetweenOffices").val(results[j].distance.text);
            $("#tripDurationBetweenOffices").val(results[j].duration.text);
        }
      }
    }
  });
}

function fncRouteZoneIntersection(response) {

    var myRoute = response.routes[0].overview_path;
    var lngLatCordinates = new Array();

    for (var i = 0; i < myRoute.length; i++) {
        lngLatCordinates.push(myRoute[i]);
    }
    return lngLatCordinates;
}

function sendPolygonForDrawing() {

    for(var i = 0; i < myPolygons.length; i++){
        poly = new Array();
        var coord = myPolygons[i].coordinates;
        var lng = coord.length;
        for (var j = 0; j < lng; j++){
            var longit_Latid = coord[j].split(',');
            poly.push(new google.maps.LatLng(parseFloat(longit_Latid[0]), parseFloat(longit_Latid[1])));
        }

        drawPolygon(poly, myPolygons[i].name);
        poly.pop();
    }
};

function drawPolygon(poly, polyLabel) {


    var options = {
        paths: poly,
        strokeColor: '#AA2143',
        strokeOpacity: 0,
        strokeWeight: 2,
        fillColor: "#FDFDFD",
        fillOpacity: 0,
        polyTitle: polyLabel
    };

    newPoly = new google.maps.Polygon(options);
    newPoly.setMap(map);
    polys.push(newPoly);

};

// Polygon getBounds extension - google-maps-extensions
if (!google.maps.Polygon.prototype.getBounds) {
  google.maps.Polygon.prototype.getBounds = function(latLng) {
    var bounds = new google.maps.LatLngBounds(),
      paths = this.getPaths(),
      path,
      p, i;

    for (p = 0; p < paths.getLength(); p++) {
      path = paths.getAt(p);
      for (i = 0; i < path.getLength(); i++) {
        bounds.extend(path.getAt(i));
      }
    }

    return bounds;
  };
}

// Polygon containsLatLng - method to determine if a latLng is within a polygon
google.maps.Polygon.prototype.containsLatLng = function(latLng) {
  // Exclude points outside of bounds as there is no way they are in the poly

  var inPoly = false,
    bounds, lat, lng,
    numPaths, p, path, numPoints,
    i, j, vertex1, vertex2;

  // Arguments are a pair of lat, lng variables
  if (arguments.length == 2) {
    if (
      typeof arguments[0] == "number" &&
      typeof arguments[1] == "number"
    ) {
      lat = arguments[0];
      lng = arguments[1];
    }
  } else if (arguments.length == 1) {
    bounds = this.getBounds();

    if (!bounds && !bounds.contains(latLng)) {
      return false;
    }
    lat = latLng.lat();
    lng = latLng.lng();
  } else {
    console.log("Wrong number of inputs in google.maps.Polygon.prototype.contains.LatLng");
  }

  // Raycast point in polygon method

  numPaths = this.getPaths().getLength();
  for (p = 0; p < numPaths; p++) {
    path = this.getPaths().getAt(p);
    numPoints = path.getLength();
    j = numPoints - 1;

    for (i = 0; i < numPoints; i++) {
      vertex1 = path.getAt(i);
      vertex2 = path.getAt(j);

      if (
        vertex1.lng() <  lng &&
        vertex2.lng() >= lng ||
        vertex2.lng() <  lng &&
        vertex1.lng() >= lng
      ) {
        if (
          vertex1.lat() +
          (lng - vertex1.lng()) /
          (vertex2.lng() - vertex1.lng()) *
          (vertex2.lat() - vertex1.lat()) <
          lat
        ) {
          inPoly = !inPoly;
        }
      }

      j = i;
    }
  }

  return inPoly;
};
$("#clickMe").click( function(){
polys =[];
myPolygons=[];
initialize();
showMap();
});
google.maps.event.addDomListener(window, 'load', initialize);
  </script>
                </div>

            </div>
        </div>

    </div>



}
